<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Películas Pendientes</title>
    <link rel="stylesheet" href="../css/pendientes.css">
</head>
<body>
    <header class="menu_header">
        <div class="logotipado">
            <img src="../storage/img/logoprincipal.svg" alt="">
            <h1>Rank My Fandom</h1>
        </div>
        <div class="opciones_menu">
            <a href="../views/admin.html">Aprobadas</a>
            <a href="../views/pendientes.html">Pendientes</a>
            <a href="../views/crearcategory.html">Crear</a>
        </div>
        <div class="opcion_notificacion">
            <img src="../storage/img/lupita.svg" alt="">
            <img src="../storage/img/campanita.svg" alt="">
        </div>
    </header>

    <article id="top_tendencia"></article>

<script>
function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.classList.add("toast", type);
    toast.textContent = message;
    document.body.appendChild(toast);

    // Mostrar animación
    setTimeout(() => toast.classList.add("show"), 100);

    // Desaparecer después de 3s
    setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

async function fetchPeliculasPendientes() {
    try {
        const resCat = await fetch("http://localhost:3000/api/v1/categories");
        const categorias = await resCat.json();

        const resMovies = await fetch("http://localhost:3000/api/v1/movies");
        const movies = await resMovies.json();

        const mainContainer = document.getElementById("top_tendencia");

        categorias.forEach(cat => {
            const peliculasDeCategoria = movies.filter(m =>
                m.categoria === cat.titulo &&
                m.estado === "pendiente"
            );

            if (peliculasDeCategoria.length === 0) return;

            const article = document.createElement("article");
            article.classList.add("top_tendencia");

            article.innerHTML = `
                <h2>${cat.titulo}</h2>
                <div class="carrusel">
                    <button class="flecha izquierda">&#10094;</button>
                    <div class="categorizacion"></div>
                    <button class="flecha derecha">&#10095;</button>
                </div>
            `;

            const contenedor = article.querySelector(".categorizacion");
            const btnIzquierda = article.querySelector(".flecha.izquierda");
            const btnDerecha = article.querySelector(".flecha.derecha");

            peliculasDeCategoria.forEach(movie => {
                const card = document.createElement("div");
                card.classList.add("caja_tendencias");
                card.innerHTML = `
                    <div class="banner-peli">
                        <img src="${movie.img}" alt="${movie.titulo}">
                    </div>
                    <div class="info_peli">
                        <div class="aceptar_propuesta">
                            <button class="boton_aceptacion">
                                <img src="../storage/img/like.svg" alt="">
                                <p>Aprobar</p>
                            </button>
                        </div>
                        <div class="rechar_propuesta">
                            <button class="boton_rechazo">
                                <img src="../storage/img/dislike.svg" alt="">
                                <p>Rechazar</p>
                            </button>
                        </div>
                    </div>
                `;
                contenedor.appendChild(card);

                // Aprobar
                card.querySelector(".boton_aceptacion").addEventListener("click", async () => {
                    try {
                        const res = await fetch(`http://localhost:3000/api/v1/movies/${movie._id}`, {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ estado: "aceptada" })
                        });
                        if (res.ok) {
                            card.remove();
                            showToast("La función se ha aprobado con éxito ✅", "success");
                        } else {
                            const data = await res.json();
                            showToast("Error al aprobar: " + data.message, "error");
                        }
                    } catch (err) {
                        console.error(err);
                        showToast("Error al aprobar la película", "error");
                    }
                });

                // Rechazar
                card.querySelector(".boton_rechazo").addEventListener("click", async () => {
                    try {
                        const res = await fetch(`http://localhost:3000/api/v1/movies/${movie._id}`, {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ estado: "rechazada" })
                        });
                        if (res.ok) {
                            card.remove();
                            showToast("La función se ha rechazado con éxito ❌", "warning");
                        } else {
                            const data = await res.json();
                            showToast("Error al rechazar: " + data.message, "error");
                        }
                    } catch (err) {
                        console.error(err);
                        showToast("Error al rechazar la película", "error");
                    }
                });
            });

            // Scroll del carrusel
            btnDerecha.addEventListener("click", () => contenedor.scrollBy({ left: 300, behavior: "smooth" }));
            btnIzquierda.addEventListener("click", () => contenedor.scrollBy({ left: -300, behavior: "smooth" }));

            mainContainer.appendChild(article);
        });

    } catch (err) {
        console.error(err);
        showToast("Error cargando películas pendientes", "error");
    }
}

document.addEventListener("DOMContentLoaded", fetchPeliculasPendientes);
</script>

</body>
</html>



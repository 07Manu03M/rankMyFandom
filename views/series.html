<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/series.css">
    <title>Series</title>
</head>

<body>
    <header class="menu_header">
        <div class="logotipado">
            <img src="../storage/img/logoprincipal.svg" alt="">
            <h1>Rank My Fandom</h1>
        </div>
        <div class="opciones_menu">
            <a href="../views/principal.html">Home</a>
            <a href="../views/peliculas.html">Peliculas</a>
            <a href="../views/series.html">Series</a>
            <a href="../views/crear.html">Crear</a>
        </div>
        <div class="infouser">
            <img src="../storage/img/usuarionormal.png" alt="">
            <p id="usernameDisplay">Usuario Normal</p>
        </div>
    </header>

    <!-- Contenedor principal donde irán todos los artículos dinámicos -->
    <article id="categorias-container"></article>

</body>

<script>
const token = localStorage.getItem("token");
let userId = null;
let username = "Usuario Normal";

if (token) {
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        userId = payload.id;
        username = payload.username || "Usuario Normal";
        document.getElementById("usernameDisplay").textContent = username;
    } catch (err) {
        console.error("Error decodificando token:", err);
        userId = "usuario123";
    }
} else {
    userId = "usuario123";
}

// ========================================
// Función principal para cargar categorías y series
// ========================================
async function fetchCategoriasYSeries() {
    try {
        const resCat = await fetch("http://localhost:3000/api/v1/categories");
        const categorias = await resCat.json();

        const resMovies = await fetch("http://localhost:3000/api/v1/movies");
        const movies = await resMovies.json();

        const mainContainer = document.getElementById("categorias-container");

        categorias.forEach(cat => {
            const article = document.createElement("article");
            article.classList.add("top_tendencia");

            article.innerHTML = `
                <h2>${cat.titulo}</h2>
                <div class="carrusel">
                    <button class="flecha izquierda">&#10094;</button>
                    <div class="categorizacion"></div>
                    <button class="flecha derecha">&#10095;</button>
                </div>
            `;

            const contenedor = article.querySelector(".categorizacion");
            const btnIzquierda = article.querySelector(".flecha.izquierda");
            const btnDerecha = article.querySelector(".flecha.derecha");

            const seriesDeCategoria = movies.filter(m =>
                m.tipo.toLowerCase() === "serie" &&
                m.categoria === cat.titulo &&
                m.estado === "aceptada"
            );

            seriesDeCategoria.forEach(serie => {
                const card = document.createElement("div");
                card.classList.add("caja_tendencias");

                // Normalizar usersLiked y usersDisliked
                const usersLiked = (serie.usersLiked || []).map(u => {
                    if (typeof u === 'string') return { id: u, nombre: u === userId ? username : "Usuario Normal" };
                    return { id: u.id || u._id, nombre: u.nombre || (u.id === userId ? username : "Usuario Normal") };
                });

                const usersDisliked = (serie.usersDisliked || []).map(u => {
                    if (typeof u === 'string') return { id: u, nombre: u === userId ? username : "Usuario Normal" };
                    return { id: u.id || u._id, nombre: u.nombre || (u.id === userId ? username : "Usuario Normal") };
                });

                const likedNames = usersLiked.map(u => u.nombre).join(', ');
                const dislikedNames = usersDisliked.map(u => u.nombre).join(', ');

                card.innerHTML = `
                    <div class="banner-peli">
                        <img src="${serie.img}" alt="${serie.titulo}">
                    </div>
                    <div class="info_peli">
                        <div class="likes_dislikes">
                            <div class="likes ${usersLiked.some(u => u.id === userId) ? 'votado' : ''}" title="${likedNames}">
                                <img src="../storage/img/like.svg">
                                <p>${serie.likes || 0}</p>
                            </div>
                            <div class="dislikes ${usersDisliked.some(u => u.id === userId) ? 'votado' : ''}" title="${dislikedNames}">
                                <img src="../storage/img/dislike.svg">
                                <p>${serie.dislikes || 0}</p>
                            </div>
                        </div>
                        <div class="comentarios" data-movie-id="${serie._id}">
                            <img src="../storage/img/comentario.png">
                            <p>${serie.comentarios || 0}</p>
                        </div>
                    </div>
                `;

                // ==============================
                // Redirigir a funcion.html con el id de la serie
                // ==============================
                card.addEventListener("click", () => {
                    window.location.href = `../views/funcion.html?id=${serie._id}`;
                });

                contenedor.appendChild(card);

                // ==============================
                // Actualizar contador de comentarios
                // ==============================
                actualizarComentariosCount(serie._id);

                const likeBtn = card.querySelector(".likes");
                const dislikeBtn = card.querySelector(".dislikes");

                likeBtn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    await votar(serie._id, "like", likeBtn, dislikeBtn);
                });

                dislikeBtn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    await votar(serie._id, "dislike", dislikeBtn, likeBtn);
                });
            });

            btnDerecha.addEventListener("click", () => contenedor.scrollBy({ left: 300, behavior: "smooth" }));
            btnIzquierda.addEventListener("click", () => contenedor.scrollBy({ left: -300, behavior: "smooth" }));

            mainContainer.appendChild(article);
        });

    } catch (err) {
        console.error("Error cargando categorías y series:", err);
    }
}

// ========================================
// Función para votar like/dislike
// ========================================
async function votar(movieId, action, btnPrincipal, btnOpuesto) {
    try {
        const res = await fetch(`http://localhost:3000/api/v1/movies/${movieId}/vote`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, username, action })
        });

        const data = await res.json();

        if (res.ok) {
            const liked = data.usersLiked.some(u => u.id === userId);
            const disliked = data.usersDisliked.some(u => u.id === userId);

            btnPrincipal.querySelector("p").textContent = action === "like" ? data.likes : data.dislikes;
            btnOpuesto.querySelector("p").textContent = action === "like" ? data.dislikes : data.likes;

            btnPrincipal.classList.toggle("votado", liked && action === "like" || disliked && action === "dislike");
            btnOpuesto.classList.toggle("votado", disliked && action === "like" || liked && action === "dislike");

            btnPrincipal.setAttribute("title", data.usersLiked.map(u => u.nombre).join(', '));
            btnOpuesto.setAttribute("title", data.usersDisliked.map(u => u.nombre).join(', '));
        } else {
            alert(data.message);
        }
    } catch (err) {
        console.error("Error votando:", err);
    }
}

// ========================================
// Función para actualizar contador de comentarios
// ========================================
async function actualizarComentariosCount(movieId) {
    try {
        const res = await fetch(`http://localhost:3000/api/v1/reviews/movie/${movieId}`);
        if (!res.ok) throw new Error("No se pudieron cargar los comentarios");

        const comentarios = await res.json(); // Devuelve un array de reviews
        const contenedor = document.querySelector(`.comentarios[data-movie-id="${movieId}"]`);
        if (contenedor) {
            contenedor.querySelector("p").textContent = comentarios.length;
        }
    } catch (err) {
        console.error("Error actualizando comentarios:", err);
    }
}

document.addEventListener("DOMContentLoaded", fetchCategoriasYSeries);
</script>

</html>




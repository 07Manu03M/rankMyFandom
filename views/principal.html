<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/principal.css">
  <title>Home</title>
</head>
<body>
  <header class="menu_header">
    <div class="logotipado">
      <img src="../storage/img/logoprincipal.svg" alt="">
      <h1>Rank My Fandom</h1>
    </div>
    <div class="opciones_menu">
      <a href="../views/principal.html">Home</a>
      <a href="../views/peliculas.html">Peliculas</a>
      <a href="../views/series.html">Series</a>
      <a href="../views/crear.html">Crear</a>
    </div>
    <div class="infouser">
      <img src="../storage/img/usuarionormal.png" alt="">
      <p id="usernameDisplay">Usuario Normal</p>
    </div>
  </header>

  <main class="cajitamain">
    <img class="banner" src="" alt="">
    <div class="descripcion">
      <div class="caja_info">
        <h1 class="titulo"></h1>
        <p class="texto"></p>
        <div class="valoracion">
          <button id="verMas">Ver más</button>
          <img src="../storage/img/like.svg" alt="">
          <img src="../storage/img/dislike.svg" alt="">
        </div>
        <div class="caja_flechas">
          <img class="flecha izquierda" src="../storage/img/flechaizquierda.svg" alt="">
          <div class="caja_carrusel" id="indicadoresContainer"></div>
          <img class="flecha derecha" src="../storage/img/flechaderecha.svg" alt="">
        </div>
      </div>
    </div>
  </main>

  <!-- Secciones dinámicas -->
  <article class="top_tendencia" id="masFamosos"></article>
  <article class="top_tendencia" id="masOdiados"></article>
  <article class="top_tendencia" id="buenasCriticas"></article>
  <article class="top_tendencia" id="malasCriticas"></article>

<script>
// ========================================
// Token y usuario
// ========================================
const token = localStorage.getItem("token");
let userId = null;
let username = "Usuario Normal";

if (token) {
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    userId = payload.id;
    username = payload.username || "Usuario Normal";
    document.getElementById("usernameDisplay").textContent = username;
  } catch(err) {
    console.error(err);
    userId = "usuario123";
  }
} else {
  userId = "usuario123";
}

// ========================================
// Cargar datos y mostrar secciones
// ========================================
async function cargarHome() {
  try {
    const res = await fetch("http://localhost:3000/api/v1/movies");
    const items = await res.json();

    // Ordenar por likes para top banner
    const top4 = [...items].sort((a,b) => b.likes - a.likes).slice(0,4);
    setupBanner(top4);

    // 10 más famosos
    mostrarSeccion("masFamosos", "10 Más Famosos", [...items].sort((a,b) => b.likes - a.likes).slice(0,10));

    // 10 más odiados
    mostrarSeccion("masOdiados", "10 Más Odiados", [...items].sort((a,b) => b.dislikes - a.dislikes).slice(0,10));

    // Buenas críticas (más comentarios)
    mostrarSeccion("buenasCriticas", "Buenas Críticas", [...items].sort((a,b) => b.comentarios - a.comentarios).slice(0,10));

    // Malas críticas (menos comentarios)
    mostrarSeccion("malasCriticas", "Aclamados Mal por la Crítica", [...items].sort((a,b) => a.comentarios - b.comentarios).slice(0,10));

  } catch(err) {
    console.error("Error cargando datos:", err);
  }
}

// ========================================
// Banner principal
// ========================================
let bannerIndex = 0;
let slides = [];

function setupBanner(items) {
  slides = items;
  const bannerImg = document.querySelector(".banner");
  const titulo = document.querySelector(".titulo");
  const texto = document.querySelector(".texto");
  const indicadoresContainer = document.getElementById("indicadoresContainer");

  indicadoresContainer.innerHTML = "";
  items.forEach((item, idx) => {
    const indicador = document.createElement("img");
    indicador.classList.add("indicador");
    indicador.src = idx===0 ? "../storage/img/rayallena.svg" : "../storage/img/rayavacia.svg";
    indicador.addEventListener("click", () => {
      bannerIndex = idx;
      mostrarSlide();
    });
    indicadoresContainer.appendChild(indicador);
  });

  function mostrarSlide() {
    const item = slides[bannerIndex];
    bannerImg.src = item.banner;
    titulo.textContent = item.titulo;
    texto.textContent = item.descripcion;
    document.getElementById("verMas").onclick = () => {
      window.location.href = `../views/funcion.html?id=${item._id}`;
    };
    const indicadores = document.querySelectorAll(".indicador");
    indicadores.forEach((ind, idx) => {
      ind.src = idx===bannerIndex ? "../storage/img/rayallena.svg" : "../storage/img/rayavacia.svg";
    });
  }

  document.querySelector(".flecha.derecha").addEventListener("click", () => {
    bannerIndex = (bannerIndex+1)%slides.length;
    mostrarSlide();
  });
  document.querySelector(".flecha.izquierda").addEventListener("click", () => {
    bannerIndex = (bannerIndex-1+slides.length)%slides.length;
    mostrarSlide();
  });

  mostrarSlide();
  setInterval(()=>{ bannerIndex=(bannerIndex+1)%slides.length; mostrarSlide(); }, 20000);
}

// ========================================
// Mostrar secciones tipo carrusel
// ========================================
function mostrarSeccion(idSeccion, tituloSeccion, items) {
  const contenedor = document.getElementById(idSeccion);
  contenedor.innerHTML = `<h2>${tituloSeccion}</h2>
    <div class="carrusel">
      <button class="flecha izquierda">&#10094;</button>
      <div class="categorizacion"></div>
      <button class="flecha derecha">&#10095;</button>
    </div>`;
  const categorizacion = contenedor.querySelector(".categorizacion");

  items.forEach(item => {
    const likedNames = (item.usersLiked || []).map(u => u.nombre).join(", ");
    const dislikedNames = (item.usersDisliked || []).map(u => u.nombre).join(", ");
    const card = document.createElement("div");
    card.classList.add("caja_tendencias");
    card.innerHTML = `
      <div class="banner-peli">
        <img src="${item.img}" alt="${item.titulo}">
      </div>
      <div class="info_peli">
        <div class="likes_dislikes">
          <div class="likes" title="${likedNames}">
            <img src="../storage/img/like.svg">
            <p>${item.likes}</p>
          </div>
          <div class="dislikes" title="${dislikedNames}">
            <img src="../storage/img/dislike.svg">
            <p>${item.dislikes}</p>
          </div>
        </div>
        <div class="comentarios">
          <img src="../storage/img/comentario.png">
          <p>${item.comentarios}</p>
        </div>
      </div>`;
    card.addEventListener("click", () => {
      window.location.href = `../views/funcion.html?id=${item._id}`;
    });
    categorizacion.appendChild(card);
  });

  // Flechas
  const btnIzq = contenedor.querySelector(".flecha.izquierda");
  const btnDer = contenedor.querySelector(".flecha.derecha");
  btnDer.addEventListener("click", ()=>categorizacion.scrollBy({ left: 300, behavior: "smooth" }));
  btnIzq.addEventListener("click", ()=>categorizacion.scrollBy({ left: -300, behavior: "smooth" }));
}

document.addEventListener("DOMContentLoaded", cargarHome);
</script>

</body>
</html>
